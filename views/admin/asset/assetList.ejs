<!-- card -->
<div class="card">
  <!-- card-box -->
  <article class="card-box">
    <div class="card-header">
      <h2 class="card-title"><%= __("administrationAsset|Asset") %></h2>
      <div class="card-header-right">
        <!-- timesearch-area -->
        <div class="timesearch-area">
          <div class="ui-radio default-style">
            <input type="radio" name="time_type" id="reg_time" checked>
            <label for="reg_time"><%= __("administrationAsset|Reg time") %></label>
          </div>
          <div class="ui-time">
            <div class="time-setting">
              <button type="button" class="btn btn-icon btn-time-setting"><span class="sr-only"><%= __("administrationAsset|Quick select") %></span></button>
              <div class="time-setting-content">
                <div class="time-setting-header">
                  <h3 class="time-setting-title"><%= __("administrationAsset|Quick select") %></h3>
                  <button type="button" class="btn-time-setting-close"><span class="sr-only"><%= __("administrationAsset|close") %></span></button>
                </div>
                <ul>
                  <li><button type="button" class="btn btn-time-choice" data-rel="today"><%= __("administrationAsset|Today") %></button></li>
                  <li><button type="button" class="btn btn-time-choice" data-rel="last7day"><%= __("administrationAsset|Last 7day") %></button></li>
                  <li><button type="button" class="btn btn-time-choice" data-rel="last30day"><%= __("administrationAsset|Last 30day") %></button></li>
                  <li><button type="button" class="btn btn-time-choice" data-rel="thisweek"><%= __("administrationAsset|This week") %></button></li>
                  <li><button type="button" class="btn btn-time-choice" data-rel="thismonth"><%= __("administrationAsset|This month") %></button></li>
                </ul>
              </div>
            </div>
            <div class="ui-datepicker datepicker-from">
              <div class="ui-input default-style"><input type="text" class="tail-datetime-field" id="from-datepicker" value="<%= dateFormat(time.from) %>" autocomplete="off"></div>
            </div>
            <span class="form-text">-</span>
            <div class="ui-datepicker datepicker-to">
              <div class="ui-input default-style"><input type="text" class="tail-datetime-field" id="to-datepicker" value="<%= dateFormat(time.to) %>" autocomplete="off"></div>
            </div>
          </div>
        </div>
        <!-- //.timesearch-area -->

        <button type="button" data-btn="filter" class="btn btn-icon btn-explore"><span class="icon icon-explore"><span class="sr-only"><%= __("administrationAsset|search") %></span></span></button>

        <!--
        * @date 2021-04-15
        * @desc add reset button
        * @company
        * -->
        <button type="button" data-btn="reset" class="btn btn-icon btn-reset"><span class="icon icon-reset"><i class="line"></i><i class="line"></i><span class="sr-only"><%= __("administrationAsset|reset") %></span></span></button>
        <!-- // @date 2021-04-15 -->
      </div>
    </div>
    <div class="card-body">
      <!-- search-area -->
      <div class="search-area">
        <div class="totalAndFilter-wrap">
          <div class="total-info">
            <dl>
              <dd>
                <%= __("administrationAsset|Total") %> -
                <%
                  // assetStatusCount = [];
                  // assetStatusCount = [{"status":0,"count":86},{"status":1,"count":33}];
                  // assetStatusCount = [{"status":1,"count":33},{"status":0,"count":86}];
                  // assetStatusCount = [{"status":0,"count":86}];
                  // assetStatusCount = [{"status":1,"count":33}];

                  (function(){
                    let total = 0
                    for (let i = 0; i < assetStatusCount.length; i++) {
                       total += assetStatusCount[i].count
                    }
                %>
                    <%= total %>
                <%
                  })()
                %>
                 /
                <span class="connected-color"><%= __("administrationAsset|Connected") %></span> -
                <%
                    if(assetStatusCount.length == 2){
                      for (let i = 0; i < assetStatusCount.length; i++) {
                        if(assetStatusCount[i].status == 1){
                %>
                          <%= assetStatusCount[i].count %>
                <%
                        }
                      }
                    }else if(assetStatusCount.length == 1){
                      if(assetStatusCount[0].status == 1){
                %>
                        <%= assetStatusCount[0].count %>
                <%
                      }else{
                %>
                        <%= "0" %>
                <%
                      }
                    }else{
                %>
                      <%= "0" %>
                <%
                    }
                %>
                 /
                <span class="disconnected-color"><%= __("administrationAsset|Disconnected") %></span> -
                <%
                    if(assetStatusCount.length == 2){
                      for (let i = 0; i < assetStatusCount.length; i++) {
                        if(assetStatusCount[i].status == 0){
                %>
                          <%= assetStatusCount[i].count %>
                <%
                        }
                      }
                    }else if(assetStatusCount.length == 1){
                      if(assetStatusCount[0].status == 0){
                %>
                        <%= assetStatusCount[0].count %>
                <%
                      }else{
                %>
                        <%= "0" %>
                <%
                      }
                    }else{
                %>
                      <%= "0" %>
                <%
                    }
                %>
              </dd>
            </dl>
          </div>
          <div class="filter-custom">
            <div class="custom-result">
            </div>
            <div class="custom-search">
              <button type="button" class="btn btn-icon btn-custom-search"><span class="icon icon-custom-search"><span class="sr-only"><%= __("administrationAsset|Add filter") %></span></span></button>
              <div class="custom-search-content">
                <div class="custom-search-header">
                  <h3 class="custom-search-title"><%= __("administrationAsset|Add filter") %></h3>
                  <button type="button" class="btn-custom-search-close"><span class="sr-only"><%= __("administrationAsset|close") %></span></button>
                </div>
                <div class="custom-search-box">
                  <div class="ui-search">
                    <div class="filter-select">
                    </div>
                    <div class="condition-box">
                    </div>
                  </div>
                </div>
                <div class="custom-search-footer">
                  <button type="button" class="btn btn-normal primary-style smaller-size btn-custom-add"><%= __("administrationAsset|Add") %></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- //.search-area -->
      <div class="pack">
        <!-- table-comp -->
        <div class="table-comp table-accordion table-check">
          <div class="table-scroll default-style">
            <div class="thead-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("administrationAsset|AssetList") %></span></caption>
                <colgroup>
                  <col style="width: 3%; " /><!-- checkbox -->
                  <col style="width: 5%; " /><!-- accordion btn -->
                  <col style="width: 20%; " /><!-- Sensor group -->
                  <col style="width: 15%; " /><!-- Sensor name -->
                  <col style="width: 15%; " /><!-- Asset name -->
                  <col style="width: 14%; " /><!-- Asset IP -->
                  <col style="width: 9%; " /><!-- Status -->
                  <col style="width: 13%; " /><!-- Allow/Deny -->
                  <col style="width: 6%; " /><!-- Edit -->
                </colgroup>
                <thead>
                  <tr>
                    <th scope="col" class="cell-check">
                      <div class="ui-checkbox default-style empty-type">
                        <input type="checkbox" name="asset-check" id="asset-check">
                        <label for="asset-check"><span class="sr-only"><%= __("administrationAsset|select") %></span></label>
                      </div>
                    </th>
                    <th scope="col" class="cell-accordion">
                      <span class="accordion-empty"></span>
                    </th>
                    <th scope="col"><%= __("administrationAsset|Sensor group") %></th>
                    <th scope="col"><%= __("administrationAsset|Sensor name") %></th>
                    <th scope="col"><%= __("administrationAsset|Name") %></th>
                    <th scope="col"><%= __("administrationAsset|IP") %></th>
                    <th scope="col"><%= __("administrationAsset|Status") %></th>
                    <th scope="col"><%= __("administrationAsset|Allow Deny") %></th>
                    <th scope="col"><%= __("administrationAsset|Edit") %></th>
                  </tr>
                </thead>
              </table>
            </div>
            <div class="tbody-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("administrationAsset|AssetList") %></span></caption>
                <colgroup>
                  <col style="width: 3%; " /><!-- checkbox -->
                  <col style="width: 5%; " /><!-- accordion btn -->
                  <col style="width: 20%; " /><!-- Sensor group -->
                  <col style="width: 15%; " /><!-- Sensor name -->
                  <col style="width: 15%; " /><!-- Asset name -->
                  <col style="width: 14%; " /><!-- Asset IP -->
                  <col style="width: 9%; " /><!-- Status -->
                  <col style="width: 13%; " /><!-- Allow/Deny -->
                  <col style="width: 6%; " /><!-- Edit -->
                </colgroup>
                <tbody>
                  <% for (let i = 0; i < ObjView.length; i++) { %>
                  <% const data = ObjView[i] %>
                  <!-- accordion-content-title -->
                  <tr class="accordion-content-title<%= data.asset_regstatus == 1 ? " is-detected cursor-pointer" : ""%>" data-asset_id="<%= data.aid %>" data-sid="<%= data.sid %>">
                    <td class="cell-check">
                      <div class="ui-checkbox default-style empty-type">
                        <input type="checkbox" name="asset<%= i %>-check" id="asset<%= i %>-check">
                        <label for="asset<%= i %>-check"><span class="sr-only"><%= __("administrationAsset|select") %></span></label>
                      </div>
                    </td>
                    <td class="cell-accordion">
                      <button type="button" class="btn btn-icon btn-accordion">
                        <span class="icon icon-accordion"><span class="sr-only"><%= __("administrationAsset|open/fold") %></span></span>
                      </button>
                    </td>
                    <td><span class="ellipsis"><%= data.group_name %></span></td>
                    <td><span class="ellipsis"><%= data.sensor_name %></span></td>
                    <td><span class="ellipsis"><%= data.asset_name %></span></td>
                    <td class="cell-center"><%= data.asset_ip %></td>
                    <td class="cell-center">
                      <% if (data.asset_status == 0) { %><span class="status status-disconnected"></span>
                      <% } else if (data.asset_status == 1) { %><span class="status status-connected"></span>
                      <% } else { %><span class="status status-default"></span>
                      <% } %>
                    </td>
                    <td class="cell-center">
                      <div class="ui-tooltip" data-tooltipevent="hover" data-direction="top-center" data-position="body">
            						<div class="btn-tooltip">
                          <div class="ui-switch default-style" data-allowed="<%= data.asset_allowed %>">
                            <input type="checkbox" name="allowed<%= i %>" id="allowed<%= i %>" <% if (data.asset_allowed == "1") {%> checked<% } %>>
                            <label for="allowed<%= i %>"><span class="sr-only">switch</span></label>
                          </div>
            						</div>
            						<div class="tooltip-contentbox" style="width: 200px;">
            							<div class="tooltip-content">
            								<%= __("administrationAsset|In order to use this function,") %><br />
                            <%= __("administrationAsset|please activate 'Assets blocking policies(Unauthorized)'") %>
            							</div>
            						</div>
            					</div>
                    </td>
                    <td class="cell-center">
                      <button type="button" data-btn="edit" class="btn btn-icon btn-edit">
                        <span class="icon icon-edit"><span class="sr-only"><%= __("administrationAsset|edit") %></span></span>
                      </button>
                    </td>
                  </tr>
                  <!-- //accordion-content-title -->
                  <!-- accordion-content -->
                  <tr class="accordion-content">
                    <td colspan="9">
                      <div class="accordion-content-box">

                      </div>
                    </td>
                  </tr>
                  <!-- //accordion-content -->
                  <% } %>
                </tbody>
              </table>
              <!--
              * @date 2021-05-31
              * @desc front performance improvement - dummy rendering
              * @company
              * -->
              <% if (ObjView.length == 0 && typeof rendering == 'undefined') { %>
              <!-- // @date 2021-05-31 -->
              <!-- empty -->
              <div class="empty">
                <div class="empty-box">
                  <div class="symbol symbol-empty">
                    <span class="symbol-icon question-style"></span>
                    <div class="symbol-figure empty-style"></div>
                  </div>
                  <p class="main-msg"><%= __("administrationAsset|No data available") %></p>
                  <p class="sub-msg"><%= __("administrationAsset|There is no data to show you right now.") %></p>
                </div>
              </div>
              <!-- //empty -->
              <% } %>
            </div>
          </div>
        </div>
        <!-- //table-comp -->
      </div>
      <div class="table-bottom">
        <div class="btn-table-box">
          <button type="button" data-btn="delete" class="btn btn-normal secondary-style"><%= __("administrationAsset|Delete") %></button>
          <button type="button" data-btn="new" class="btn btn-normal primary-style"><%= __("administrationAsset|New asset") %></button>
        </div>
        <div class="table-bottom-right">
          <%- include ('../../../views/include/pagination.ejs', {pages: pages, current: current}) %>
          <div class="ui-select default-style" data-direction="up">
            <select name="" id="listEntries">
              <option value="10" selected><%= __("administrationAsset|Show 10 entries") %></option>
              <option value="20"><%= __("administrationAsset|Show 20 entries") %></option>
              <option value="30"><%= __("administrationAsset|Show 30 entries") %></option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </article>
  <!-- //card-box -->
</div>
<!-- //card -->

<% if(typeof rendering == 'undefined') { %>
<script>
  logdata('/admin/asset/:[num]', <%- JSON.stringify(locals) %>);
</script>

<script>
  (function(){
    const treeDataObj = {}
    treeData.forEach((element)=>treeDataObj[element.sid] = {...element});
    $('#listTable .tbody-scroll tbody tr.accordion-content-title').each(function(){
      const $this = $(this);
      const $thisAllowed = $this.find('[data-allowed]');
      const sid = $this.data('sid');
      const {unauthorised_block} = treeDataObj[sid] || {};
      const $thisTooltip = $thisAllowed.closest('.ui-tooltip');
      $thisAllowed.find('input').prop('disabled', !!!unauthorised_block);
      $thisTooltip.attr('data-tooltip-disabled', !!unauthorised_block);
      if(!!unauthorised_block) $thisTooltip.find('.btn-tooltip').removeClass('btn-tooltip');
    });
  })();
</script>

<script>
  maintainState();
</script>

<script>
  var getPage = () => {
    const page = $('#pagination .active').closest('.page-item').data('page') || 1;
    return page;
  }
  var getEntries = () => {
    const entries = $('#listEntries option:selected').val() || 10;
    return entries
  }
  var getSID = () => {
    let sid = $.map($('#tree').find('.tree-item.sensor-type.checked'), function(e){
      return $(e).data('sid');
    });

    sid = getTypeCheckedSensorKey('.tree-comp', '.tree-type', '.sensor-type', sid);

    return sid
  }
  var getTime = () => {
    const time = {
      type: 'regtime',
      from: $.trim($('#from-datepicker').val()),
      to: $.trim($('#to-datepicker').val())
    }
    return time;
  }
  var getFilter = () => {
    /**
    * @date 2021-05-06
    * @desc fix bug about duplicated filter condition
    * @company
    */
    const $list = $('#listTable');
    const $customResult = $list.find('.custom-result');
    const $resultItem = $customResult.find('.result-item');
    /*************************************/
    const filters = $.map($resultItem, function(element){
      const filterSelect = $(element).find('.result-title').data('result-key');
      const filterCondition = $(element).find('.result-text').data('result-value');
      const filter = {};
      filter[filterSelect] = filterCondition;
      return filter
    });
    return filters.length ? filters : null;
  }
  var getStateFilter = () => {
    /**
    * @date 2021-05-06
    * @desc fix bug about duplicated filter condition
    * @company
    */
    const $list = $('#listTable');
    const $customResult = $list.find('.custom-result');
    const $resultItem = $customResult.find('.result-item');
    /*************************************/
    const filters = $.map($resultItem, function(element){
      const $filterTitle = $(element).find('.result-title');
      const $filterText = $(element).find('.result-text');
      const filterSelect = $filterTitle.data('result-key');
      const filterCondition = $filterText.data('result-value');
      const filterSelectText = $filterTitle.text();
      const filterConditionText = $filterText.text();
      const filter = {key: {originval: filterSelect, dataval: filterSelectText }, value: {originval: filterCondition, dataval: filterConditionText}};
      return filter
    });
    return filters.length ? filters : null;
  }
</script>
<script>
  setTime('.ui-time');
  dateTime('.ui-time');
	filterCustom('.filter-custom', {data: customFilterCondition});
  tableCheck('.table-check');
  tableAccordion('.table-accordion', {
    beforeSlideDown : function(obj){
      const asset_id = obj.btnEle.closest('tr').data('asset_id');
      return requestDetail(asset_id, obj);
    },
    afterSlideUp: function(obj){
      obj.btnEle.closest('tr').prev('.accordion-content').find('.accordion-content-box').html('');
    }
  });
  selectDropdown('.ui-select');
  formWidth();
  tooltip('.ui-tooltip[data-tooltip-disabled="false"]');
</script>

<script>
  maintainState();
</script>

<script>
  // entries 변경
  $('#listEntries').off('change.entries').on('change.entries', function(){
    const page = 1;
    const entries = $(this).find('option:selected').val() || 10;
    const sid = getSID();

    /**
    * @date 2021-04-16
    * @desc fix bug to send temp condition(time+filter)
    * @company
    */
    const time = getState().time ? getState().time : null;
    const filters = getState().filter && getState().filter.map((ele) => {return {[ele.key.originval]: ele.value.originval}});
    /*************************************/

    setState({page: page, entries: entries});
    requestList(page, entries, sid, time, filters);
  });

  // page 변경
  $('#pagination .page-link').off('click.pagination').on('click.pagination', function(e){
    e.preventDefault();
    const page = $(this).closest('.page-item').data('page') || 1;
    const entries = $('#listEntries option:selected').val() || 10;
    const sid = getSID();

    /**
    * @date 2021-04-16
    * @desc fix bug to send temp condition(time+filter)
    * @company
    */
    const time = getState().time ? getState().time : null;
    const filters = getState().filter && getState().filter.map((ele) => {return {[ele.key.originval]: ele.value.originval}});
    /*************************************/

    setState({page: page});
    requestList(page, entries, sid, time, filters);
  });

  $('[data-btn="filter"]').off('click.filter').on('click.filter', function(e){
    const page = 1;
    const entries = $('#listEntries option:selected').val() || 10;
    const sid = getSID();

    const time = getTime();
    const filters = getFilter();
    const stateFilter = getStateFilter() || [];

    setState({page: page, time: time, filter: stateFilter});

    requestList(page, entries, sid, time, filters);
  });

  /**
  * @date 2021-04-15
  * @desc add reset button
  * @company
  */
  $('[data-btn="reset"]').off('click.reset').on('click.reset', function(e){
    const page = 1;
    const entries = $('#listEntries option:selected').val() || 10;
    const sid = getSID();

    const time = null;
    const filters = null;
    const stateFilter = [];

    setState({page: page, time: time, filter: filters});

    requestList(page, entries, sid, time, stateFilter);
  });
  /*************************************/
</script>

<script>
  // new sensor
  $('[data-btn="new"]').off('click.openNewSensor').on('click.openNewSensor', function(){

    const sidGid = getSubContext();

    const dataValue = {
      tree_groups: treeData,
      gid: sidGid.gid,
      sid: sidGid.sid
    }

    requestNewPopup(dataValue);
  });
</script>

<script>
  // edit 수정
  $('[data-btn="edit"]').off('click.edit').on('click.edit', function(){

    const asset_id = $(this).closest('tr').data('asset_id') || 1;

    const dataValue = {
      aid: asset_id,
      tree_groups: treeData
    }

    requestEditPopup(dataValue, asset_id);
  });

  $('#listTable .accordion-content-title').each(function(){
    const $asset = $(this);
    const asset_id = $(this).closest('tr').data('asset_id') || 1;

    // block-unauthorized
    $asset.find('[data-allowed] input').on('change', function(){
      const dataValue = {
        aid: asset_id,
        asset_allowed: $(this).is(":checked") ? "1" : "0"
      }

      fetch(`/admin/asset/assetupdate`,{
        method: 'PUT',
        body: JSON.stringify(dataValue),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(function(response){
        if(response.status == 500){ alertModalControl('open', 'alertError', '<%= __("administrationAsset|Error!") %>'); }
      })
      .catch(function(errors){console.error('Error:', errors)});

    });
  });
</script>
<script>
  $('[data-btn="delete"]').off('click.delete').on('click.delete', function(){
    const tableCheckedId = $.map($('#listTable').find('.cell-check input:checked'), function(ele){
      return $(ele).closest('tr').data('asset_id');
    });

    requestDelete(tableCheckedId);
  });
</script>
<% } else { %>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    selectDropdown('.ui-select.default-style');
    formWidth();
  });
</script>
<% } %>
