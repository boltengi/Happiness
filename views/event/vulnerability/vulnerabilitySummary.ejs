<!-- deck-wrap -->
<div class="deck-wrap">
  <div class="deck-bar-devide-wrap">
    <div class="deck-bar-devide" data-codetype>
      <article class="deck loading-parent" id="codetype-graph">
				<div class="deck-header">
					<h1 class="deck-title"><%= __("eventVulnerability|Vulnerability assortment") %></h1>
					<div class="deck-header-right">
            <span class="deck-term-text">(<%= __("eventVulnerability|Week") %>)</span>
						<span class="deck-total-text" data-total><span class="num">0</span></span>
					</div>
				</div>
				<div class="deck-body">
          <div class="deck-bar-wrap">
            <div class="bar-graph-box" data-zeroday>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|Zeroday") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph zeroday-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
            <div class="bar-graph-box" data-oneday>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|Oneday") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph oneday-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
            <div class="bar-graph-box" data-cve>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|CVE") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph cve-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
          </div>
				</div>
			</article>
    </div>
    <div class="deck-bar-devide" data-top>
      <article class="deck loading-parent" id="top-graph">
				<div class="deck-header">
					<h1 class="deck-title"><%= __("eventVulnerability|Vulnerability Top 5") %></h1>
					<div class="deck-header-right">
            <span class="deck-term-text">(<%= __("eventVulnerability|Week") %>)</span>
						<span class="deck-total-text" data-total><span class="num">0</span></span>
					</div>
				</div>
				<div class="deck-body">
          <!-- table-comp -->
					<div class="table-comp">
						<table class="table summary-style">
							<caption>table</caption>
							<colgroup>
								<col style="width: 53% " />
                <col style="width: 47% " />
							</colgroup>
							<thead>
								<tr>
									<th scope="col"><%= __("eventVulnerability|Vulnerability code") %></th>
									<th scope="col"><%= __("eventVulnerability|Count") %></th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
					<!-- //table-comp -->
				</div>
			</article>
    </div>
    <div class="deck-bar-devide" data-event>
      <article class="deck loading-parent" id="event-graph">
				<div class="deck-header">
					<h1 class="deck-title"><%= __("eventVulnerability|Event processing status") %></h1>
          <div class="deck-header-right">
            <span class="deck-term-text">(<%= __("eventVulnerability|Week") %>)</span>
						<span class="deck-total-text" data-total><span class="num">0</span></span>
					</div>
				</div>
				<div class="deck-body">
          <div class="deck-bar-wrap">
            <div class="bar-graph-box" data-complete>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|Processed") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph alpha-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
            <div class="bar-graph-box" data-incomplete>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|Pending process") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph beta-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
            <div class="bar-graph-box" data-unconfirmed>
              <h2 class="bar-graph-title">
                <span class="title"><%= __("eventVulnerability|To be processed") %></span>
                <span class="value"><span class="num">0</span></span>
              </h2>
              <div class="bar-graph gamma-style">
                <span class="bar-graph-bar"></span>
              </div>
            </div>
          </div>
				</div>
			</article>
    </div>
  </div>
</div>
<!-- //deck-wrap -->
<style>
  #myDoughnutHighChart {
    width: 170px;
    height: 170px;
  }
</style>

<% if(typeof rendering == 'undefined') { %>
<!--
* @date 2021-05-14
* @desc front performance improvement by lighthouse
* @company
* -->
<script src="/js/ui-lib.highcharts.min.js"></script>
<!-- // @date 2021-05-14 -->
<script>
  var setStatusCodetype = function(data){

    logdata('/event/vulnerability/status/codetype', data);

    const dummyData = [{count: "20300", status: 0},{count: "2030", status: 1},{count: "10300", status: 2}];
    const ObjView = data.ObjView || dummyData;

    const $codetype = $('[data-codetype]');
    let total = 0;
    let cve = 0;
    let zeroday = 0;
    let oneday = 0;

    $.each(ObjView, function(index, element){
      const count = Number(element.count);
      total += count;
      if (element.codeType == 0) zeroday = count;
      if (element.codeType == 1) cve = count;
      if (element.codeType == 2) oneday = count;
    });

    $codetype.find('[data-total]').find('.num').html(format.numComma(total));
    $codetype.find('[data-zeroday]').find('.num').html(format.numComma(zeroday));
    $codetype.find('[data-zeroday]').find('.bar-graph-bar').css({width: zeroday/total*100 + '%'});
    $codetype.find('[data-oneday]').find('.num').html(format.numComma(oneday));
    $codetype.find('[data-oneday]').find('.bar-graph-bar').css({width: oneday/total*100 + '%'});
    $codetype.find('[data-cve]').find('.num').html(format.numComma(cve));
    $codetype.find('[data-cve]').find('.bar-graph-bar').css({width: cve/total*100 + '%'});

    return { isLoading: true };
  }
  var setStatusTop = function(data){

    logdata('/event/vulnerability/status/top', data);

    const ObjView = data.ObjView;

    const $top = $('[data-top]');
    let total = 0;
    let connection = 0;
    let disconnection = 0;

    $.each(ObjView, function(index, element){
      const count = Number(element.count);
      total += count;
    });

    $.each(ObjView, function(index, element){
      $top.find('.table-comp tbody').append(`<tr>
        <td class="cell-center">${element.code}</td>
        <td class="cell-center"><strong>${format.numComma(element.count)}</strong></td>
      </tr>`);
    });

    $top.find('[data-total]').find('.num').html(format.numComma(total));

    return { isLoading: true };
  }
  var setStatusEvent = function(data){

    logdata('/event/vulnerability/status/event', data);

    const ObjView = data.ObjView;

    const $event = $('[data-event]');
    let total = 0;
    let complete = 0;
    let incomplete = 0;
    let unconfirmed = 0;

    $.each(ObjView, function(index, element){
      const count = Number(element.count);
      total += count;
      if (element.status === true) complete = count;
      if (element.status === false) incomplete = count;
      if (element.status === null) unconfirmed = count;
    });

    $event.find('[data-total]').find('.num').html(format.numComma(total));
    $event.find('[data-complete]').find('.num').html(format.numComma(complete));
    $event.find('[data-complete]').find('.bar-graph-bar').css({width: complete/total*100 + '%'});
    $event.find('[data-incomplete]').find('.num').html(format.numComma(incomplete));
    $event.find('[data-incomplete]').find('.bar-graph-bar').css({width: incomplete/total*100 + '%'});
    $event.find('[data-unconfirmed]').find('.num').html(format.numComma(unconfirmed));
    $event.find('[data-unconfirmed]').find('.bar-graph-bar').css({width: unconfirmed/total*100 + '%'});

    return { isLoading: true };
  }
</script>
<script>
  var codetypeData = requestStatus('codetype');
  codetypeData
  .then((data)=>{
    data.loading.setLoaded(true);
    return data.data
  })
  .then(setStatusCodetype)
  .then(function (data) {
    if(data.isLoading){
      const $loadingParent = $(`#codetype-graph`);
      removeLoading($loadingParent);
    }
  });

  var topData = requestStatus('top');
  topData
  .then((data)=>{
    data.loading.setLoaded(true);
    return data.data
  })
  .then(setStatusTop)
  .then(function (data) {
    if(data.isLoading){
      const $loadingParent = $(`#top-graph`);
      removeLoading($loadingParent);
    }
  });

  var eventData = requestStatus('event');
  eventData
  .then((data)=>{
    data.loading.setLoaded(true);
    return data.data
  })
  .then(setStatusEvent)
  .then(function (data) {
    if(data.isLoading){
      const $loadingParent = $(`#event-graph`);
      removeLoading($loadingParent);
    }
  });
</script>
<% } %>
