<!-- card -->
<div class="card">
  <!-- card-box -->
  <article class="card-box">
    <div class="card-header">
      <h2 class="card-title"><%= __("vulnerability|Vulnerability list") %></h2>
      <div class="card-header-right">
        <!-- timesearch-area -->
				<div class="timesearch-area">
					<div class="ui-radio default-style">
						<input type="radio" name="time_type" id="detection_time" checked>
						<label for="detection_time"><%= __("vulnerability|Processed time") %></label>
					</div>
					<div class="ui-time">
						<div class="time-setting">
							<button type="button" class="btn btn-icon btn-time-setting"><span class="sr-only"><%= __("vulnerability|Quick select") %></span></button>
							<div class="time-setting-content">
								<div class="time-setting-header">
									<h3 class="time-setting-title"><%= __("vulnerability|Quick select") %></h3>
									<button type="button" class="btn-time-setting-close"><span class="sr-only"><%= __("vulnerability|close") %></span></button>
								</div>
								<ul>
									<li><button type="button" class="btn btn-time-choice" data-rel="today"><%= __("vulnerability|Today") %></button></li>
									<li><button type="button" class="btn btn-time-choice" data-rel="last7day"><%= __("vulnerability|Last 7day") %></button></li>
									<li><button type="button" class="btn btn-time-choice" data-rel="last30day"><%= __("vulnerability|Last 30day") %></button></li>
									<li><button type="button" class="btn btn-time-choice" data-rel="thisweek"><%= __("vulnerability|This week") %></button></li>
									<li><button type="button" class="btn btn-time-choice" data-rel="thismonth"><%= __("vulnerability|This month") %></button></li>
								</ul>
							</div>
						</div>
						<div class="ui-datepicker datepicker-from">
					    <div class="ui-input default-style"><input type="text" class="tail-datetime-field" id="from-datepicker" value="<%= dateFormat(time.from) %>" autocomplete="off"></div>
						</div>
						<span class="form-text">-</span>
						<div class="ui-datepicker datepicker-to">
					    <div class="ui-input default-style"><input type="text" class="tail-datetime-field" id="to-datepicker" value="<%= dateFormat(time.to) %>" autocomplete="off"></div>
						</div>
					</div>
				</div>
				<!-- //.timesearch-area -->
        <button type="button" data-btn="filter" class="btn btn-icon btn-explore"><span class="icon icon-explore"><span class="sr-only"><%= __("vulnerability|search") %></span></span></button>

        <!--
        * @date 2021-04-15
        * @desc add reset button
        * @company
        * -->
        <button type="button" data-btn="reset" class="btn btn-icon btn-reset"><span class="icon icon-reset"><i class="line"></i><i class="line"></i><span class="sr-only"><%= __("vulnerability|reset") %></span></span></button>
        <!-- // @date 2021-04-15 -->
      </div>
    </div>
    <div class="card-body">
      <!-- search-area -->
      <div class="search-area">
        <div class="filter-custom">
        	<div class="custom-result">
        	</div>
					<div class="custom-search">
						<button type="button" class="btn btn-icon btn-custom-search"><span class="icon icon-custom-search"><span class="sr-only"><%= __("vulnerability|Add filter") %></span></span></button>
						<div class="custom-search-content">
							<div class="custom-search-header">
								<h3 class="custom-search-title"><%= __("vulnerability|Add filter") %></h3>
								<button type="button" class="btn-custom-search-close"><span class="sr-only"><%= __("vulnerability|close") %></span></button>
							</div>
							<div class="custom-search-box">
								<div class="ui-search">
									<div class="filter-select">
									</div>
									<div class="condition-box">
									</div>
								</div>
							</div>
							<div class="custom-search-footer">
								<button type="button" class="btn btn-normal primary-style smaller-size btn-custom-add"><%= __("vulnerability|Add") %></button>
							</div>
						</div>
					</div>
        </div>
      </div>
      <!-- //.search-area -->
      <div class="pack">
        <!-- table-comp -->
        <div class="table-comp">
          <div class="table-scroll default-style">
            <div class="thead-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("vulnerability|vulnerabilityList") %></span></caption>
                <colgroup>
                  <col style="width: 15%; " /><!-- Processed time -->
                  <col style="width: 15%; " /><!-- Vulnerability type -->
                  <col style="width: 18%; " /><!-- Vulnerability code -->
                  <col style="width: 22%; " /><!-- Sensor name -->
                  <col style="width: 20%; " /><!-- Severity -->
                  <col style="width: 10%; " /><!-- Assets counted -->
                </colgroup>
                <thead>
                  <tr>
                    <th scope="row"><%= __("vulnerability|Processed time") %></th>
                    <th scope="row"><%= __("vulnerability|Vulnerability type") %></th>
                    <th scope="row"><%= __("vulnerability|Vulnerability code") %></th>
                    <th scope="row"><%= __("vulnerability|Sensor name") %></th>
                    <th scope="row"><%= __("vulnerability|Severity") %></th>
                    <th scope="row"><%= __("vulnerability|Assets counted") %></th>
                  </tr>
                </thead>
              </table>
            </div>
            <div class="tbody-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("vulnerability|vulnerabilityList") %></span></caption>
                <colgroup>
                  <col style="width: 15%; " /><!-- Processed time -->
                  <col style="width: 15%; " /><!-- Vulnerability type -->
                  <col style="width: 18%; " /><!-- Vulnerability code -->
                  <col style="width: 22%; " /><!-- Sensor name -->
                  <col style="width: 20%; " /><!-- Severity -->
                  <col style="width: 10%; " /><!-- Assets counted -->
                </colgroup>
                <tbody>
                  <% for (let i = 0; i < ObjView.length; i++) { %>
                  <% const data = ObjView[i] %>
                  <tr data-vulnerability_id="<%= data.idx %>" data-sensor_id="<%= data.sensor_id %>">
                    <td class="cell-center"><%= dateFormat(data.detection_time) %></td>
                    <td class="cell-center">
                    <%  if(data.vulnerability_type == 0){ %>
                      <%= __("vulnerability|Zeroday") %>
                    <%  }else if(data.vulnerability_type == 1){ %>
                      <%= __("vulnerability|CVE") %>
                    <%  }else if(data.vulnerability_type == 2){ %>
                      <%= __("vulnerability|Oneday") %>
                    <%  } %>
                    </td>
                    <td class="cell-center cell-link" data-link><%= data.vulnerability_code %></td>
                    <td><%= data.sensor_name %></td>
                    <td class="cell-center">
                    <%  if(data.severity == 0){ %>
                      <span class="severity severity-low"><%= __("vulnerability|Low") %></span>
                    <%  }else if(data.severity == 1){ %>
                      <span class="severity severity-medium"><%= __("vulnerability|Medium") %></span>
                    <%  }else if(data.severity == 2){ %>
                      <span class="severity severity-high"><%= __("vulnerability|High") %></span>
                    <%  }else if(data.severity == 3){ %>
                      <span class="severity severity-critical"><%= __("vulnerability|Critical") %></span>
                    <%  } %>
                    </td>
                    <td class="cell-center"><%= data.detection_count %></td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
              <!--
              * @date 2021-05-31
              * @desc front performance improvement - dummy rendering
              * @company
              * -->
              <% if (ObjView.length == 0 && typeof rendering == 'undefined') { %>
              <!-- // @date 2021-05-31 -->
              <!-- empty -->
              <div class="empty">
                <div class="empty-box">
                  <div class="symbol symbol-empty">
                    <span class="symbol-icon question-style"></span>
                    <div class="symbol-figure empty-style"></div>
                  </div>
                  <p class="main-msg"><%= __("vulnerability|No data available") %></p>
                  <p class="sub-msg"><%= __("vulnerability|There is no data to show you right now.") %></p>
                </div>
              </div>
              <!-- //empty -->
              <% } %>
            </div>
          </div>
        </div>
        <!-- //table-comp -->
      </div>
      <div class="table-bottom">
        <div class="table-bottom-right">
          <%- include ('../../../views/include/pagination.ejs', {pages: pages, current: current}) %>
          <div class="ui-select default-style" data-direction="up">
            <select name="" id="listEntries">
              <option value="10" selected><%= __("vulnerability|Show 10 entries") %></option>
              <option value="20"><%= __("vulnerability|Show 20 entries") %></option>
              <option value="30"><%= __("vulnerability|Show 30 entries") %></option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </article>
  <!-- //card-box -->
</div>
<!-- //card -->

<% if(typeof rendering == 'undefined') { %>
<script>
  logdata('/vulnerability/vulnerability/:[num]', <%- JSON.stringify(locals) %>);
</script>
<script>
  maintainState();
</script>
<script>
  selectDropdown('.ui-select.default-style');
  dateTime('.ui-time');
  setTime('.ui-time');
	filterCustom('.filter-custom', {data: customFilterCondition})
  formWidth();
</script>
<script>
  maintainState();
</script>
<script>
var getPage = () => {
  const page = $('#pagination .active').closest('.page-item').data('page') || 1;
  return page;
}
var getEntries = () => {
  const entries = $('#listEntries option:selected').val() || 10;
  return entries
}
var getSensorID = () => {
  let sensor_id = $.map($('#tree').find('.tree-item.sensor-type.checked'), function(e){
    return $(e).data('sensor_id');
  });
  sensor_id = getTypeCheckedSensorKey('.tree-comp', '.tree-type', '.sensor-type', sensor_id);
  return sensor_id
}
var getTime = () => {
  const time = {
    type: 'detection_time',
    from: $('#from-datepicker').val(),
    to: $('#to-datepicker').val()
  }
  return time;
}
var getFilter = () => {
  /**
  * @date 2021-05-06
  * @desc fix bug about duplicated filter condition
  * @company
  */
  const $list = $('#listTable');
  const $customResult = $list.find('.custom-result');
  const $resultItem = $customResult.find('.result-item');
  /*************************************/
  const filters = $.map($resultItem, function(element){
    const filterSelect = $(element).find('.result-title').data('result-key');
    const filterCondition = $(element).find('.result-text').data('result-value');
    const filter = {};
    filter[filterSelect] = filterCondition;
    return filter
  });
  return filters.length ? filters : null;
}
var getStateFilter = () => {
  /**
  * @date 2021-05-06
  * @desc fix bug about duplicated filter condition
  * @company
  */
  const $list = $('#listTable');
  const $customResult = $list.find('.custom-result');
  const $resultItem = $customResult.find('.result-item');
  /*************************************/
  const filters = $.map($resultItem, function(element){
    const $filterTitle = $(element).find('.result-title');
    const $filterText = $(element).find('.result-text');
    const filterSelect = $filterTitle.data('result-key');
    const filterCondition = $filterText.data('result-value');
    const filterSelectText = $filterTitle.text();
    const filterConditionText = $filterText.text();
    const filter = {key: {originval: filterSelect, dataval: filterSelectText }, value: {originval: filterCondition, dataval: filterConditionText}};
    return filter
  });
  return filters.length ? filters : null;
}
</script>
<script>
  // entries 변경
  $('#listEntries').off('change.entries').on('change.entries', function(){
    const page = 1;
    const entries = $(this).find('option:selected').val() || 10;
    const sensor_id = getSensorID();

    /**
    * @date 2021-04-16
    * @desc fix bug to send temp condition(time+filter)
    * @company
    */
    const time = getState().time ? getState().time : null;
    const filters = getState().filter && getState().filter.map((ele) => {return {[ele.key.originval]: ele.value.originval}});
    /*************************************/

    setState({page: page, entries: entries});

    requestList(page, entries, sensor_id, time, filters);
  });

  // page 변경
  $('#pagination .page-link').off('click.pagination').on('click.pagination', function(e){
    e.preventDefault();
    const page = $(this).closest('.page-item').data('page') || 1;
    const entries = getEntries() || 10;
    const sensor_id = getSensorID() || [];

    /**
    * @date 2021-04-16
    * @desc fix bug to send temp condition(time+filter)
    * @company
    */
    const time = getState().time ? getState().time : null;
    const filters = getState().filter && getState().filter.map((ele) => {return {[ele.key.originval]: ele.value.originval}});
    /*************************************/

    setState({page: page});

    requestList(page, entries, sensor_id, time, filters);
  });

  $('[data-btn="filter"]').off('click.filter').on('click.filter', function(e){
    const page = 1;
    const entries = getEntries() || 10;
    const sensor_id = getSensorID() || [];

    const time = getTime();
    const filters = getFilter();
    const stateFilter = getStateFilter() || [];

    setState({page: page, time: time, filter: stateFilter});

    requestList(page, entries, sensor_id, time, filters);
  });

  /**
  * @date 2021-04-15
  * @desc add reset button
  * @company
  */
  $('[data-btn="reset"]').off('click.reset').on('click.reset', function(e){
    const page = 1;
    const entries = $('#listEntries option:selected').val() || 10;
    const sensor_id = getSensorID() || [];

    const time = null;
    const filters = null;
    const stateFilter = [];

    setState({page: page, time: time, filter: filters});

    requestList(page, entries, sensor_id, time, stateFilter);
  });
  /*************************************/
</script>
<script>
  $('#listTable tbody [data-link]').off('click.detail').on('click.detail', function(){
    const $tr = $(this).closest('tr');
    const vulnerability_id = $tr.data('vulnerability_id');
    const sensor_id = $tr.data('sensor_id') || '';
    location.href = '/vulnerability/vulnerability/vulnerabilityDetail/' + vulnerability_id + '?sensor_id=' + sensor_id;
  });
</script>
<% } else { %>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    selectDropdown('.ui-select.default-style');
    formWidth();
  });
</script>
<% } %>
