<!-- card-box -->
<article class="card-box">
  <div class="card-header">
    <h2 class="card-title"><%= __("asset|Vulnerabilities") %></h2>
  </div>
  <div class="card-body">
    <!-- card-content -->
    <div class="card-content">
      <!-- search-area -->
      <div class="search-area">
        <div class="ui-select default-style medium-size" data-width="200px">
          <select name="" id="vulnerabilityTime">
            <option value="1"><%= __("asset|Today") %></option>
            <option value="7" selected><%= __("asset|Last 7day") %></option>
            <option value="30"><%= __("asset|Last 30day") %></option>
          </select>
        </div>
      </div>
      <!-- //.search-area -->
      <div class="pack">
        <!-- table-comp -->
        <div class="table-comp">
          <div class="table-scroll default-style">
            <div class="thead-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("asset|VulnerabilityList") %></span></caption>
                <colgroup>
                  <col style="width: 25%; " /><!-- Processed time -->
                  <col style="width: 25%; " /><!-- Vulnerability type -->
                  <col style="width: 25%; " /><!-- Vulnerability code -->
                  <col style="width: 25%; " /><!-- Severity -->
                </colgroup>
                <thead>
                  <tr>
                    <th scope="row"><%= __("asset|Processed time") %></th>
                    <th scope="row"><%= __("asset|Vulnerability type") %></th>
                    <th scope="row"><%= __("asset|Vulnerability code") %></th>
                    <th scope="row"><%= __("asset|Severity") %></th>
                  </tr>
                </thead>
              </table>
            </div>
            <div class="tbody-scroll">
              <table class="table default-style">
                <caption><span class="sr-only"><%= __("asset|VulnerabilityList") %></span></caption>
                <colgroup>
                  <col style="width: 25%; " /><!-- Processed time -->
                  <col style="width: 25%; " /><!-- Vulnerability type -->
                  <col style="width: 25%; " /><!-- Vulnerability code -->
                  <col style="width: 25%; " /><!-- Severity -->
                </colgroup>
                <tbody>
                  <% for (let i = 0; i < ObjView.length; i++) { %>
                  <% const data = ObjView[i] %>
                  <tr data-vulnerability_id="<%= data.idx %>"  data-sensor_id="<%= data.sensor_id %>">
                    <td class="cell-center"><%= dateFormat(data.detection_time) %></td>
                    <td class="cell-center"><%= data.vulnerability_type %></td>
                    <td class="cell-center cell-link" data-link><%= data.vulnerability_code %></td>
                    <td class="cell-center">
                      <% if (data.severity == 0) { %>
                        <span class="severity severity-low"><%= __("asset|Low") %></span>
                      <% } else if (data.severity == 1) { %>
                        <span class="severity severity-medium"><%= __("asset|Medium") %></span>
                      <% } else if (data.severity == 2) { %>
                        <span class="severity severity-high"><%= __("asset|High") %></span>
                      <% } else if (data.severity == 3) { %>
                        <span class="severity severity-critical"><%= __("asset|Critical") %></span>
                      <% } %>
                    </td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
              <% if (ObjView.length == 0) { %>
              <!-- empty -->
              <div class="empty">
                <div class="empty-box">
                  <div class="symbol symbol-empty">
                    <span class="symbol-icon question-style"></span>
                    <div class="symbol-figure empty-style"></div>
                  </div>
                  <p class="main-msg"><%= __("asset|No data available") %></p>
                  <p class="sub-msg"><%= __("asset|There is no data to show you right now.") %></p>
                </div>
              </div>
              <!-- //empty -->
              <% } %>
            </div>
          </div>
        </div>
        <!-- //table-comp -->
      </div>
      <div class="table-bottom">
        <div class="table-bottom-right">
          <%- include ('../../../views/include/pagination.ejs', {pages: pages, current: current}) %>
          <div class="ui-select default-style" data-direction="up">
            <select name="" id="vulnerabilityEntries">
              <option value="10" selected><%= __("asset|Show 10 entries") %></option>
              <option value="20"><%= __("asset|Show 20 entries") %></option>
              <option value="30"><%= __("asset|Show 30 entries") %></option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <!-- //card-content -->
  </div>
</article>
<!-- //card-box -->

<script>
  logdata('/asset/detection/assetVulnerability', <%- JSON.stringify(locals) %>);
</script>
<script>
  maintainState();
</script>

<script>
  selectDropdown('.ui-select');
  formWidth();
</script>
<script>
  // entries 변경
  $('#vulnerabilityTime').off('change.vulnerabilityTime').on('change.vulnerabilityTime', function(){
    const asset_id = location.href.split('/')[location.href.split('/').length-1];
    const page = 1;
    const entries = $('#vulnerabilityEntries option:selected').val() || 10;
    const time = $(this).find('option:selected').val() || 7;
    setState({vulnerabilityPage: page, vulnerabilityTime: time});
    requestVulnerability(asset_id, page, entries, time);
  });

  // entries 변경
  $('#vulnerabilityEntries').off('change.vulnerabilityEntries').on('change.vulnerabilityEntries', function(){
    const asset_id = location.href.split('/')[location.href.split('/').length-1];
    const page = 1;
    const entries = $(this).find('option:selected').val() || 10;
    const time = $('#vulnerabilityTime').find('option:selected').val() || 7;
    setState({vulnerabilityPage: page, vulnerabilityEntries: entries});
    requestVulnerability(asset_id, page, entries, time);
  });


  // pagination 변경
  $('#pagination .page-link').off('click.pagination').on('click.pagination', function(e){
    e.preventDefault();
    const asset_id = location.href.split('/')[location.href.split('/').length-1];
    const page = $(this).closest('.page-item').data('page') || 1;
    const entries = $('#vulnerabilityEntries option:selected').val() || 10;
    const time = $('#vulnerabilityTime').find('option:selected').val() || 7;
    setState({vulnerabilityPage: page});
    requestVulnerability(asset_id, page, entries, time);
  });
</script>

<script>
  $('#vulnerabilityList tbody [data-link]').off('click.go_vulnerabiltiy').on('click.go_vulnerabiltiy', function(){
    const $tr = $(this).closest('tr');
    const vulnerability_id = $tr.data('vulnerability_id');
    const sensor_id = getQueryString().sensor_id || '';
    const asset_id = location.href.split('/')[location.href.split('/').length-1].split('?')[0];
    location.href = '/vulnerability/vulnerability/vulnerabilityDetail/' + vulnerability_id + '?sensor_id=' + sensor_id  + '&' + 'asset_id=' + asset_id;
  });
</script>
